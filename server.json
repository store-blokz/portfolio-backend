const express = require('express');
const nodemailer = require('nodemailer');
const cors = require('cors');
const { v4: uuidv4 } = require('uuid');
const fs = require('fs-extra');
const rateLimit = require('express-rate-limit');
require('dotenv').config();
let server;

const app = express();
const PORT = process.env.PORT || 5000;
const BASE_URL = process.env.BASE_URL || `http://localhost:${PORT}`;
const CONFIG_FILE = './configs.json';

// Middleware
app.use(cors());
app.use(express.json());

// Rate Limiting
const limiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 100, // Limit each IP to 100 requests per window
    message: 'Too many requests from this IP, please try again later.'
});
app.use('/api/', limiter);

// Nodemailer Transporter
const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASS
    }
});

// Check Environment Variables
const hasCredentials = process.env.EMAIL_USER && process.env.EMAIL_PASS;
if (!hasCredentials) {
    console.warn('\x1b[33m%s\x1b[0m', 'WARNING: EMAIL_USER or EMAIL_PASS not found in .env. Server will log emails to console instead of sending them.');
}

// Helper: Load/Save Configs
const loadConfigs = async () => {
    try {
        if (!await fs.exists(CONFIG_FILE)) {
            await fs.writeJson(CONFIG_FILE, {});
        }
        return await fs.readJson(CONFIG_FILE);
    } catch (err) {
        console.error('Error loading configs:', err);
        return {};
    }
};

const saveConfig = async (key, config) => {
    const configs = await loadConfigs();
    configs[key] = config;
    await fs.writeJson(CONFIG_FILE, configs);
};

// API: Request Backend (Onboarding)
app.post('/api/request-backend', async (req, res) => {
    const { name, email, useCase } = req.body;

    if (!email || !name) {
        return res.status(400).json({ success: false, message: 'Name and Email are required.' });
    }

    const formKey = uuidv4();
    const config = {
        name,
        email,
        useCase,
        createdAt: new Date(),
        active: true
    };

    try {
        await saveConfig(formKey, config);

        // Onboarding Email Content
        const onboardSubject = 'Welcome to FormFreedom - Your Backend is Ready!';
        const onboardHtml = `
            <div style="font-family: sans-serif; line-height: 1.6; color: #333;">
                <h2>Hello ${name},</h2>
                <p>Your FormFreedom backend has been configured successfully!</p>
                <p><strong>Your Form Key:</strong> <code>${formKey}</code></p>
                <hr />
                <h3>How to use it:</h3>
                <p>To collect form submissions, simply send a <code>POST</code> request to this URL:</p>
                <p><code>${BASE_URL}/api/s/${formKey}</code></p>
                <p>All data sent to this endpoint will be automatically forwarded to your email: <strong>${email}</strong>.</p>
                <hr />
                <p>If you need custom routing (e.g., to Discord or Google Sheets) or have any questions, feel free to contact us at <a href="mailto:vivekg.work@gmail.com">vivekg.work@gmail.com</a>.</p>
            </div>
        `;

        if (hasCredentials) {
            await transporter.sendMail({
                from: `"FormFreedom" <${process.env.EMAIL_USER}>`,
                to: email,
                subject: onboardSubject,
                html: onboardHtml
            });
        } else {
            console.log('\x1b[36m%s\x1b[0m', '--- [DEV MODE] New Onboarding Request ---');
            console.log(`To: ${email}\nSubject: ${onboardSubject}\nKey: ${formKey}`);
            console.log('--- END ONBOARDING LOG ---');
        }

        res.status(200).json({ success: true, message: 'Onboarding request processed!', mode: hasCredentials ? 'email' : 'log' });
    } catch (error) {
        console.error('Onboarding error:', error);
        res.status(500).json({ success: false, message: 'Failed to process request.' });
    }
});

// API: Generic Submission Endpoint
app.post('/api/s/:key', async (req, res) => {
    const { key } = req.params;
    const submissionData = req.body;

    // Honeypot check (assuming forms add a hidden 'b_hp' field)
    if (submissionData.b_hp) {
        console.warn('Bot submission detected for key:', key);
        return res.status(200).json({ success: true, message: 'Processed' }); // Silently ignore
    }

    try {
        const configs = await loadConfigs();
        const config = configs[key];

        if (!config || !config.active) {
            return res.status(404).json({ success: false, message: 'Invalid or inactive form key.' });
        }

        const mailOptions = {
            from: `"FormFreedom" <${process.env.EMAIL_USER}>`,
            to: config.email,
            subject: `New Form Submission: ${config.useCase || 'General'}`,
            html: `
                <div style="font-family: sans-serif; line-height: 1.6; color: #333;">
                    <h2>New Submission Received</h2>
                    <p>You have received a new submission through your FormFreedom endpoint.</p>
                    <hr />
                    <pre style="background: #f4f4f4; padding: 15px; border-radius: 5px;">${JSON.stringify(submissionData, null, 2)}</pre>
                    <hr />
                    <p>Sent via <a href="http://localhost:5173">FormFreedom</a></p>
                </div>
            `
        };

        if (hasCredentials) {
            await transporter.sendMail(mailOptions);
        } else {
            console.log('\x1b[35m%s\x1b[0m', '--- [DEV MODE] New Submission ---');
            console.log(`To: ${config.email}\nSubject: ${mailOptions.subject}`);
            console.log('Data:', submissionData);
            console.log('--- END SUBMISSION LOG ---');
        }

        res.status(200).json({ success: true, message: 'Submission processed!', mode: hasCredentials ? 'email' : 'log' });
    } catch (error) {
        console.error('Submission error:', error);
        res.status(500).json({ success: false, message: 'Failed to process submission.' });
    }
});

// Start Server
const startServer = () => {
    server = app.listen(PORT, () => {
        console.log(`FormFreedom Server running on http://localhost:${PORT}`);
    });

    server.on('error', (err) => {
        if (err.code === 'EADDRINUSE') {
            console.log(`âš ï¸ Port ${PORT} busy... retrying in 1s`);
            setTimeout(() => {
                server.close();
                startServer();
            }, 1000);
        } else {
            console.error('Server error:', err);
        }
    });
};

startServer();


// Graceful Shutdown (Fixes Nodemon Restart Crash)
const shutdown = () => {
    if (server) {
        console.log('\nðŸ›‘ Shutting down server...');
        server.close(() => {
            console.log('âœ… Server closed cleanly');
            process.exit(0);
        });
    } else {
        process.exit(0);
    }
};

process.on('SIGINT', shutdown);
process.on('SIGTERM', shutdown);
process.on('SIGUSR2', shutdown); // Needed for nodemon
